function RayCasta(r,v){v||(v={});this.WIDTH=v.width||r.canvas.width;this.HEIGHT=v.height||r.canvas.height;this.context=r}
(function(r){function v(a,b){this.x=b.x||0;this.y=b.y||0;this.w=b.w||50;this.h=b.h||50;this.ex=this.x+this.w;this.ey=this.y+this.h;if(!a)throw"'texture' parameter is mandatory";this.texture=a;this.textureData=B(this.texture)}function E(a,b){this.x=b.x||0;this.y=b.y||0;if(!a)throw"'texture' parameter is mandatory";this.texture=a;this.textureData=B(this.texture)}function C(a,b){this.x=a.x||0;this.y=a.y||0;this.dx=a.dx||1;this.dy=a.dy||0;this.px=0;this.py=b.WIDTH/b.HEIGHT/2}function D(a,b){this.HEIGHT_MODIFIER=
a.heightDelta||20;this.SHADOW_MODIFIER=a.shadowDelta||.02;this.STRIPE_WIDTH=a.vertLineWidth||3;this.LINE_WIDTH=a.horLineWidth||2;this.rcInstance=b;if(0!==this.rcInstance.WIDTH%this.STRIPE_WIDTH)throw"Canvas width not divisible by vertLineWidth("+this.STRIPE_WIDTH+")";this.__zBuffer=new Float32Array(this.rcInstance.WIDTH);this.__cameraLookup=new Float32Array(this.rcInstance.WIDTH);for(var c=0;c<this.rcInstance.WIDTH;c++)this.__cameraLookup[c]=2*c/this.rcInstance.WIDTH-1}function F(a,b){var c=-Infinity,
g=Infinity,p=!0,e=!0,m=!0,d=(b.x-a.ox)/a.dx,f=(b.ex-a.ox)/a.dx;d>f&&(p=d,d=f,f=p,p=!1);if(f<c||d>g)return null;d>c&&(c=d);f<g&&(g=f);d=(b.y-a.oy)/a.dy;f=(b.ey-a.oy)/a.dy;d>f&&(e=d,d=f,f=e,e=!1);if(f<c||d>g)return null;d>c&&(m=!1,c=d);f<g&&(g=f);return(c=c>g?null:c)&&0<c?(a.dist=c,a.side=m?p?3:1:e?0:2,!0):null}function y(a,b,c){b=a/(b*c);return b>a?a:b}function B(a){var b=document.createElement("canvas"),c=b.getContext("2d");b.width=a.width;b.height=a.height;c.clearRect(0,0,a.width,a.height);c.drawImage(a,
0,0);b=c.getImageData(0,0,a.width,a.height);c=Array(a.width*a.height);for(var g=0;g<a.width*a.height;g++)c[g]=new Uint8Array([b.data[4*g],b.data[4*g+1],b.data[4*g+2],b.data[4*g+3]]);return c}r.AABB=function(a,b){return new v(a,b||{})};r.Sprite=function(a,b){return new E(a,b||{})};C.prototype.rotate=function(a,b){var c=Math.cos(b?-a:a),g=Math.sin(b?-a:a),p=this.dx,e=this.px;this.dx=this.dx*c-this.dy*g;this.dy=p*g+this.dy*c;this.px=this.px*c-this.py*g;this.py=e*g+this.py*c};r.Camera=function(a){return new C(a||
{},this)};D.prototype.render=function(a,b,c){for(var g=this.rcInstance.context.getImageData(0,0,this.rcInstance.WIDTH,this.rcInstance.HEIGHT),p=g.data,e={ox:a.x,oy:a.y},m=0;m<this.rcInstance.WIDTH;m+=this.STRIPE_WIDTH){var d=this.__cameraLookup[m];e.dx=a.dx+a.px*d;e.dy=a.dy+a.py*d;d=Infinity;for(var f=null,n=null,l=0;l<b.length;l++){var k=b[l];F(e,k)&&e.dist<d&&(d=e.dist,f=e.side,n=k)}for(l=0;l<this.STRIPE_WIDTH;l++)this.__zBuffer[m+l]=d;if(n){l=~~(this.HEIGHT_MODIFIER*this.rcInstance.HEIGHT/d);var q=
~~((this.rcInstance.HEIGHT-l)/2);k=q%this.LINE_WIDTH;q-=k;k=~~((this.rcInstance.HEIGHT+l)/2)-k;0>q&&(q=0);k>this.rcInstance.HEIGHT&&(k=this.rcInstance.HEIGHT);var u=n.texture.height,h=void 0;0===f?h=u*Math.abs(n.ex-(e.ox+e.dx*d)):1===f?h=u*Math.abs(n.ey-(e.oy+e.dy*d)):2===f?h=u*Math.abs(n.x-(e.ox+e.dx*d)):3===f&&(h=u*Math.abs(n.y-(e.oy+e.dy*d)));for(f=~~(h/this.HEIGHT_MODIFIER%u);q<k;q+=this.LINE_WIDTH){var w=n.textureData[u*~~((2*q-this.rcInstance.HEIGHT+l)*u/(2*l))+f];if(w){h=y(w[0],d,this.SHADOW_MODIFIER);
var r=y(w[1],d,this.SHADOW_MODIFIER);w=y(w[2],d,this.SHADOW_MODIFIER);for(var t=0;t<this.STRIPE_WIDTH;t++)for(var x=0;x<this.LINE_WIDTH;x++)i=4*this.rcInstance.WIDTH*(q+x)+4*(m+t),p[i+0]=h,p[i+1]=r,p[i+2]=w,p[i+3]=255}}}}for(b=0;b<c.length;b++)m=c[b],m.__distance=(e.ox-m.x)*(e.ox-m.x)+(e.oy-m.y)*(e.oy-m.y);c.sort(function(a,b){return b.__distance-a.__distance});b=1/(a.px*a.dy-a.dx*a.py);for(m=0;m<c.length;m++)if(d=c[m],l=d.x-e.ox,k=d.y-e.oy,n=b*(-a.py*l+a.px*k),l=~~(this.rcInstance.WIDTH/2*(1+b*(a.dy*
l-a.dx*k)/n)),k=Math.abs(this.HEIGHT_MODIFIER*this.rcInstance.HEIGHT/n),u=Math.round(-k/2+this.rcInstance.HEIGHT/2),f=Math.round(k/2+this.rcInstance.HEIGHT/2),h=Math.round(-k/2+l),q=Math.round(k/2+l),!(0>=n||h>this.rcInstance.WIDTH||0>q))for(0>h&&(h=0),q>this.rcInstance.WIDTH&&(q=this.rcInstance.WIDTH),0>u&&(u=0),f>this.rcInstance.HEIGHT&&(f=this.rcInstance.HEIGHT),isFinite(this.__zBuffer[h])&&this.__zBuffer[h]<n&&(h-=h%this.STRIPE_WIDTH);h<q;h+=this.STRIPE_WIDTH)if(0<=h&&h<this.rcInstance.WIDTH&&
n<this.__zBuffer[h]){r=~~((h-(-k/2+l))*d.texture.width/k);for(t=w=1;t<this.STRIPE_WIDTH;t++)n<this.__zBuffer[h+t]&&w++;for(t=u;t<f;t+=this.LINE_WIDTH)if((x=d.textureData[d.texture.width*~~((2*t-this.rcInstance.HEIGHT+k)*d.texture.height/k/2)+r])&&0!==x[3])for(var v=0;v<w;v++)for(var A=0;A<this.LINE_WIDTH;A++){var z=4*this.rcInstance.WIDTH*(t+A)+4*(h+v);p[z+0]=y(x[0],n,this.SHADOW_MODIFIER);p[z+1]=y(x[1],n,this.SHADOW_MODIFIER);p[z+2]=y(x[2],n,this.SHADOW_MODIFIER);p[z+3]=x[3]}}this.rcInstance.context.putImageData(g,
0,0)};r.Renderer=function(a){return new D(a||{},this)}})(RayCasta.prototype);