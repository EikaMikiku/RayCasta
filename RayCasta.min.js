function RayCasta(f){this.HEIGHT_MODIFIER=f.heightDelta||20;this.SHADOW_MODIFIER=f.shadowDelta||.02;this.STRIPE_WIDTH=f.vertLineWidth||3;this.LINE_WIDTH=f.horLineWidth||2;if("number"!==typeof f.width)throw"'width' parameter is mandatory";this.WIDTH=f.width;if("number"!==typeof f.height)throw"'height' parameter is mandatory";this.HEIGHT=f.height;if(0!==this.WIDTH%this.STRIPE_WIDTH)throw"'width' parameter("+this.WIDTH+") is not divisible by vertLineWidth parameter("+this.STRIPE_WIDTH+")";this.__zBuffer=
new Float32Array(this.WIDTH);this.__cameraLookup=new Float32Array(this.WIDTH);for(f=0;f<this.WIDTH;f++)this.__cameraLookup[f]=2*f/this.WIDTH-1}
(function(f){function D(a,g){var b=-Infinity,e=Infinity,f=!0,p=!0,h=!0,d=(g.x-a.ox)/a.dx,c=(g.ex-a.ox)/a.dx;d>c&&(f=d,d=c,c=f,f=!1);if(c<b||d>e)return null;d>b&&(b=d);c<e&&(e=c);d=(g.y-a.oy)/a.dy;c=(g.ey-a.oy)/a.dy;d>c&&(p=d,d=c,c=p,p=!1);if(c<b||d>e)return null;d>b&&(h=!1,b=d);c<e&&(e=c);return(b=b>e?null:b)&&0<b?(a.dist=b,a.side=h?f?3:1:p?0:2,!0):null}function x(a,g,b){g=a/(g*b);return g>a?a:g}function C(a){var g=document.createElement("canvas"),b=g.getContext("2d");g.width=a.width;g.height=a.height;
b.clearRect(0,0,a.width,a.height);b.drawImage(a,0,0);g=b.getImageData(0,0,a.width,a.height);b=Array(a.width*a.height);for(var e=0;e<a.width*a.height;e++)b[e]=new Uint8Array([g.data[4*e],g.data[4*e+1],g.data[4*e+2],g.data[4*e+3]]);return b}RayCasta.AABB=function(a){this.x=a.x||0;this.y=a.y||0;this.w=a.w||50;this.h=a.h||50;this.ex=this.x+this.w;this.ey=this.y+this.h;if("object"!==typeof a.tex)throw"'tex' parameter is mandatory";this.tex=a.tex;this.texData=C(this.tex)};RayCasta.Sprite=function(a){this.x=
a.x||0;this.y=a.y||0;if("object"!==typeof a.tex)throw"'tex' parameter is mandatory";this.tex=a.tex;this.texData=C(this.tex)};RayCasta.Camera=function(a){this.x=a.x||0;this.y=a.y||0;this.dx=a.dx||1;this.dy=a.dy||0;this.px=0;if("number"!==typeof a.width)throw"'width' parameter is mandatory";if("number"!==typeof a.height)throw"'height' parameter is mandatory";this.py=a.width/a.height/2};RayCasta.Camera.prototype.rotate=function(a,g){var b=Math.cos(g?-a:a),e=Math.sin(g?-a:a),f=this.dx,p=this.px;this.dx=
this.dx*b-this.dy*e;this.dy=f*e+this.dy*b;this.px=this.px*b-this.py*e;this.py=p*e+this.py*b};f.render=function(a,g,b,e){for(var f=g.getImageData(0,0,this.WIDTH,this.HEIGHT),p=f.data,h={ox:a.x,oy:a.y},d=0;d<this.WIDTH;d+=this.STRIPE_WIDTH){var c=this.__cameraLookup[d];h.dx=a.dx+a.px*c;h.dy=a.dy+a.py*c;c=Infinity;for(var t=null,n=null,m=0;m<b.length;m++){var l=b[m];D(h,l)&&h.dist<c&&(c=h.dist,t=h.side,n=l)}for(m=0;m<this.STRIPE_WIDTH;m++)this.__zBuffer[d+m]=c;if(n){m=~~(this.HEIGHT_MODIFIER*this.HEIGHT/
c);var q=~~((this.HEIGHT-m)/2);l=q%this.LINE_WIDTH;q-=l;l=~~((this.HEIGHT+m)/2)-l;0>q&&(q=0);l>this.HEIGHT&&(l=this.HEIGHT);var u=n.tex.height,k=void 0;0===t?k=u*Math.abs(n.ex-(h.ox+h.dx*c)):1===t?k=u*Math.abs(n.ey-(h.oy+h.dy*c)):2===t?k=u*Math.abs(n.x-(h.ox+h.dx*c)):3===t&&(k=u*Math.abs(n.y-(h.oy+h.dy*c)));for(t=~~(k/this.HEIGHT_MODIFIER%u);q<l;q+=this.LINE_WIDTH){var v=n.texData[u*~~((2*q-this.HEIGHT+m)*u/(2*m))+t];if(v){k=x(v[0],c,this.SHADOW_MODIFIER);var z=x(v[1],c,this.SHADOW_MODIFIER);v=x(v[2],
c,this.SHADOW_MODIFIER);for(var r=0;r<this.STRIPE_WIDTH;r++)for(var w=0;w<this.LINE_WIDTH;w++)i=4*this.WIDTH*(q+w)+4*(d+r),p[i+0]=k,p[i+1]=z,p[i+2]=v,p[i+3]=255}}}}for(b=0;b<e.length;b++)d=e[b],d.__distance=(h.ox-d.x)*(h.ox-d.x)+(h.oy-d.y)*(h.oy-d.y);e.sort(function(a,b){return b.__distance-a.__distance});b=1/(a.px*a.dy-a.dx*a.py);for(d=0;d<e.length;d++)if(c=e[d],m=c.x-h.ox,l=c.y-h.oy,n=b*(-a.py*m+a.px*l),m=~~(this.WIDTH/2*(1+b*(a.dy*m-a.dx*l)/n)),l=Math.abs(this.HEIGHT_MODIFIER*this.HEIGHT/n),u=
Math.round(-l/2+this.HEIGHT/2),t=Math.round(l/2+this.HEIGHT/2),k=Math.round(-l/2+m),q=Math.round(l/2+m),!(0>=n||k>this.WIDTH||0>q))for(0>k&&(k=0),q>this.WIDTH&&(q=this.WIDTH),0>u&&(u=0),t>this.HEIGHT&&(t=this.HEIGHT),isFinite(this.__zBuffer[k])&&this.__zBuffer[k]<n&&(k-=k%this.STRIPE_WIDTH);k<q;k+=this.STRIPE_WIDTH)if(0<=k&&k<this.WIDTH&&n<this.__zBuffer[k]){z=~~((k-(-l/2+m))*c.tex.width/l);for(r=v=1;r<this.STRIPE_WIDTH;r++)n<this.__zBuffer[k+r]&&v++;for(r=u;r<t;r+=this.LINE_WIDTH)if((w=c.texData[c.tex.width*
~~((2*r-this.HEIGHT+l)*c.tex.height/l/2)+z])&&0!==w[3])for(var A=0;A<v;A++)for(var B=0;B<this.LINE_WIDTH;B++){var y=4*this.WIDTH*(r+B)+4*(k+A);p[y+0]=x(w[0],n,this.SHADOW_MODIFIER);p[y+1]=x(w[1],n,this.SHADOW_MODIFIER);p[y+2]=x(w[2],n,this.SHADOW_MODIFIER);p[y+3]=w[3]}}g.putImageData(f,0,0)}})(RayCasta.prototype);