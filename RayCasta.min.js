function RayCasta(r,v){v||(v={});this.WIDTH=v.width||r.canvas.width;this.HEIGHT=v.height||r.canvas.height;this.context=r}
(function(r){function v(a,b){this.x=b.x||0;this.y=b.y||0;this.w=b.w||50;this.h=b.h||50;this.ex=this.x+this.w;this.ey=this.y+this.h;if(!a)throw"'texture' parameter is mandatory";this.texture=a;this.textureData=A(this.texture)}function D(a,b){this.x=b.x||0;this.y=b.y||0;if(!a)throw"'texture' parameter is mandatory";this.texture=a;this.textureData=A(this.texture)}function B(a,b){this.x=a.x||0;this.y=a.y||0;this.dx=a.dx||1;this.dy=a.dy||0;this.px=0;this.py=b.WIDTH/b.HEIGHT/2}function C(a,b){this.HEIGHT_MODIFIER=
a.heightDelta||20;this.SHADOW_MODIFIER=a.shadowDelta||.02;this.STRIPE_WIDTH=a.vertLineWidth||3;this.LINE_WIDTH=a.horLineWidth||2;this.processPixelColor=a.processPixelColorFunc||E;this.rcInstance=b;if(0!==this.rcInstance.WIDTH%this.STRIPE_WIDTH)throw"Canvas width not divisible by vertLineWidth("+this.STRIPE_WIDTH+")";this.__zBuffer=new Float32Array(this.rcInstance.WIDTH);this.__cameraLookup=new Float32Array(this.rcInstance.WIDTH);for(var d=0;d<this.rcInstance.WIDTH;d++)this.__cameraLookup[d]=2*d/this.rcInstance.WIDTH-
1}function F(a,b){var d=-Infinity,f=Infinity,p=!0,e=!0,n=!0,c=(b.x-a.ox)/a.dx,g=(b.ex-a.ox)/a.dx;c>g&&(p=c,c=g,g=p,p=!1);if(g<d||c>f)return null;c>d&&(d=c);g<f&&(f=g);c=(b.y-a.oy)/a.dy;g=(b.ey-a.oy)/a.dy;c>g&&(e=c,c=g,g=e,e=!1);if(g<d||c>f)return null;c>d&&(n=!1,d=c);g<f&&(f=g);return(d=d>f?null:d)&&0<d?(a.dist=d,a.side=n?p?3:1:e?0:2,!0):null}function E(a,b,d,f){a=b/(d*f);return a>b?b:a}function A(a){var b=document.createElement("canvas"),d=b.getContext("2d");b.width=a.width;b.height=a.height;d.clearRect(0,
0,a.width,a.height);d.drawImage(a,0,0);b=d.getImageData(0,0,a.width,a.height);d=Array(a.width*a.height);for(var f=0;f<a.width*a.height;f++)d[f]=new Uint8Array([b.data[4*f],b.data[4*f+1],b.data[4*f+2],b.data[4*f+3]]);return d}r.AABB=function(a,b){return new v(a,b||{})};r.Sprite=function(a,b){return new D(a,b||{})};B.prototype.rotate=function(a,b){var d=Math.cos(b?-a:a),f=Math.sin(b?-a:a),p=this.dx,e=this.px;this.dx=this.dx*d-this.dy*f;this.dy=p*f+this.dy*d;this.px=this.px*d-this.py*f;this.py=e*f+this.py*
d};r.Camera=function(a){return new B(a||{},this)};C.prototype.render=function(a,b,d){for(var f=this.rcInstance.context.getImageData(0,0,this.rcInstance.WIDTH,this.rcInstance.HEIGHT),p=f.data,e={ox:a.x,oy:a.y},n=0;n<this.rcInstance.WIDTH;n+=this.STRIPE_WIDTH){var c=this.__cameraLookup[n];e.dx=a.dx+a.px*c;e.dy=a.dy+a.py*c;c=Infinity;for(var g=null,k=null,m=0;m<b.length;m++){var l=b[m];F(e,l)&&e.dist<c&&(c=e.dist,g=e.side,k=l)}for(m=0;m<this.STRIPE_WIDTH;m++)this.__zBuffer[n+m]=c;if(k){m=~~(this.HEIGHT_MODIFIER*
this.rcInstance.HEIGHT/c);var q=~~((this.rcInstance.HEIGHT-m)/2);l=q%this.LINE_WIDTH;q-=l;l=~~((this.rcInstance.HEIGHT+m)/2)-l;0>q&&(q=0);l>this.rcInstance.HEIGHT&&(l=this.rcInstance.HEIGHT);var u=k.texture.height,h=void 0;0===g?h=u*Math.abs(k.ex-(e.ox+e.dx*c)):1===g?h=u*Math.abs(k.ey-(e.oy+e.dy*c)):2===g?h=u*Math.abs(k.x-(e.ox+e.dx*c)):3===g&&(h=u*Math.abs(k.y-(e.oy+e.dy*c)));for(g=~~(h/this.HEIGHT_MODIFIER%u);q<l;q+=this.LINE_WIDTH){var w=k.textureData[u*~~((2*q-this.rcInstance.HEIGHT+m)*u/(2*m))+
g];if(w){h=this.processPixelColor(k,w[0],c,this.SHADOW_MODIFIER);var r=this.processPixelColor(k,w[1],c,this.SHADOW_MODIFIER);w=this.processPixelColor(k,w[2],c,this.SHADOW_MODIFIER);for(var t=0;t<this.STRIPE_WIDTH;t++)for(var x=0;x<this.LINE_WIDTH;x++)i=4*this.rcInstance.WIDTH*(q+x)+4*(n+t),p[i+0]=h,p[i+1]=r,p[i+2]=w,p[i+3]=255}}}}for(b=0;b<d.length;b++)n=d[b],n.__distance=(e.ox-n.x)*(e.ox-n.x)+(e.oy-n.y)*(e.oy-n.y);d.sort(function(a,b){return b.__distance-a.__distance});b=1/(a.px*a.dy-a.dx*a.py);
for(n=0;n<d.length;n++)if(c=d[n],m=c.x-e.ox,l=c.y-e.oy,k=b*(-a.py*m+a.px*l),m=~~(this.rcInstance.WIDTH/2*(1+b*(a.dy*m-a.dx*l)/k)),l=Math.abs(this.HEIGHT_MODIFIER*this.rcInstance.HEIGHT/k),u=Math.round(-l/2+this.rcInstance.HEIGHT/2),g=Math.round(l/2+this.rcInstance.HEIGHT/2),h=Math.round(-l/2+m),q=Math.round(l/2+m),!(0>=k||h>this.rcInstance.WIDTH||0>q))for(0>h&&(h=0),q>this.rcInstance.WIDTH&&(q=this.rcInstance.WIDTH),0>u&&(u=0),g>this.rcInstance.HEIGHT&&(g=this.rcInstance.HEIGHT),isFinite(this.__zBuffer[h])&&
this.__zBuffer[h]<k&&(h-=h%this.STRIPE_WIDTH);h<q;h+=this.STRIPE_WIDTH)if(0<=h&&h<this.rcInstance.WIDTH&&k<this.__zBuffer[h]){r=~~((h-(-l/2+m))*c.texture.width/l);for(t=w=1;t<this.STRIPE_WIDTH;t++)k<this.__zBuffer[h+t]&&w++;for(t=u;t<g;t+=this.LINE_WIDTH)if((x=c.textureData[c.texture.width*~~((2*t-this.rcInstance.HEIGHT+l)*c.texture.height/l/2)+r])&&0!==x[3])for(var v=0;v<w;v++)for(var z=0;z<this.LINE_WIDTH;z++){var y=4*this.rcInstance.WIDTH*(t+z)+4*(h+v);p[y+0]=this.processPixelColor(c,x[0],k,this.SHADOW_MODIFIER);
p[y+1]=this.processPixelColor(c,x[1],k,this.SHADOW_MODIFIER);p[y+2]=this.processPixelColor(c,x[2],k,this.SHADOW_MODIFIER);p[y+3]=x[3]}}this.rcInstance.context.putImageData(f,0,0)};r.Renderer=function(a){return new C(a||{},this)}})(RayCasta.prototype);